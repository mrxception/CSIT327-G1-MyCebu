{% extends 'mycebu_app/landing_base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'mycebu_app/css/directory.css' %}">

<style>
    /* --- Spinner Styles --- */
    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e6eef0;
        border-top-color: var(--primary, #0d9488);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Animation for cards */
    .card {
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .card.visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* CRITICAL: When the parent section has class "loading", 
       hide all tab panels (filters + grids) immediately. 
    */
    .tab-content-section.loading .tab-panel {
        display: none !important;
    }
</style>

<section class="tab-content-section" id="directorySection" data-skel="directory-all">
    <header class="dir-hero">
        <div class="container">
            <div class="dir-hero__badge">üèõÔ∏è Government Directory</div>
            <h1 class="dir-hero__title">Cebu City Directory</h1>
            <p class="dir-hero__desc">Find local officials, department offices, and emergency hotlines.</p>
        </div>
    </header>

    <div class="container" style="margin-top:8px;">
        <nav class="tabs tabs--bar" role="tablist">
            <button class="tab-btn is-active" data-tab="officials" onclick="switchTab('officials')">OFFICIALS DIRECTORY</button>
            <button class="tab-btn" data-tab="offices" onclick="switchTab('offices')">DEPARTMENT OFFICES</button>
            <button class="tab-btn" data-tab="hotlines" onclick="switchTab('hotlines')">EMERGENCY HOTLINES</button>
        </nav>
    </div>

    <div id="directoryLoading" style="display:none; text-align:center; padding:60px 20px; color:#6b7280; background:#f8fafc; margin-top: 20px; border-radius: 8px;">
        <div class="spinner"></div> 
        <span style="font-size: 1.1em; font-weight: 500;">Loading directory data...</span>
    </div>

    <section class="tab-panel" data-panel="officials" style="display:block;">
        <div class="filter-bar">
            <form class="container" id="form-officials" onsubmit="return false;">
                <div class="grid grid-3">
                    <div class="input-wrap">
                        <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2" />
                            <path d="M20 20L16.65 16.65" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <input class="input input--search" id="q-officials" type="text" placeholder="Search by name, position, or office">
                    </div>

                    <div class="input-wrap">
                        <select id="pos-officials" class="input" style="background-color: white;">
                            <option value="all">All Positions</option>
                        </select>
                    </div>

                    <div class="input-wrap">
                        <select id="dist-officials" class="input" style="background-color: white;">
                            <option value="all">All Districts</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>

        <div class="py-12">
            <div class="container px-4">
                <div class="text-center" style="margin-bottom:24px">
                    <div class="dir-hero__badge" style="background:var(--secondary); color:white">Department Officials</div>
                    <h2 class="h2" style="margin-top:8px">Cebu City Department Officials</h2>
                    <p class="muted">Government directory of the government officials in Cebu City.</p>
                </div>

                <div class="dir-grid" id="grid-officials"></div>
                <div class="empty-msg" id="empty-officials" style="display:none; text-align:center; padding:20px;">No Officials Found</div>
            </div>
        </div>
    </section>

    <section class="tab-panel" data-panel="offices" style="display:none;">
        <div class="filter-bar">
            <form class="container" id="form-offices" onsubmit="return false;">
                <div class="grid">
                    <div class="input-wrap">
                        <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2" />
                            <path d="M20 20L16.65 16.65" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <input class="input input--search" id="q-offices" type="text" placeholder="Search by office name or head">
                    </div>
                </div>
            </form>
        </div>

        <div class="py-12">
            <div class="container">
                <div class="text-center" style="margin-bottom:24px">
                    <div class="dir-hero__badge" style="background:var(--primary); color:white">Department Offices</div>
                    <h2 class="h2" style="margin-top:8px">Cebu City Department Offices</h2>
                    <p class="muted">Quick access to the essential government department offices in Cebu City.</p>
                </div>

                <div class="dir-grid" id="grid-offices"></div>
                <div class="empty-msg" id="empty-offices" style="display:none; text-align:center; padding:20px;">No Offices Found</div>
            </div>
        </div>
    </section>

    <section class="tab-panel" data-panel="hotlines" style="display:none;">
        <div class="filter-bar">
            <form class="container" id="form-hotlines" onsubmit="return false;">
                <div class="grid">
                    <div class="input-wrap">
                        <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2" />
                            <path d="M20 20L16.65 16.65" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <input class="input input--search" id="q-hotlines" type="text" placeholder="Search by service or number">
                    </div>
                </div>
            </form>
        </div>

        <div class="py-12">
            <div class="container px-4">
                <div class="text-center" style="margin-bottom:24px">
                    <div class="dir-hero__badge" style="background:rgb(219, 64, 64); color:white">Emergency Hotlines</div>
                    <h2 class="h2" style="margin-top:8px">Emergency Contact Numbers</h2>
                    <p class="muted">Quick access to essential emergency services and government hotlines in Cebu City.</p>
                </div>

                <div class="dir-grid" id="grid-hotlines"></div>
                <div class="empty-msg" id="empty-hotlines" style="display:none; text-align:center; padding:20px;">No Hotlines Found</div>
            </div>
        </div>
    </section>
</section>

<script>
// --- Configuration ---
const STATIC_BASE_URL = "{% static 'mycebu_app/images/directory-profiles/' %}";

// --- Global Data Store ---
let directoryData = {
    officials: [],
    offices: [],
    hotlines: [],
    filters: { positions: [], districts: [] }
};

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const currentTab = urlParams.get('t') || 'officials';
    switchTab(currentTab);

    // Fetch Data
    fetchDirectoryData();

    setupListener('q-officials', filterOfficials);
    setupListener('pos-officials', filterOfficials, 'change');
    setupListener('dist-officials', filterOfficials, 'change');
    setupListener('q-offices', filterOffices);
    setupListener('q-hotlines', filterHotlines);
});

function setupListener(id, fn, evt='input') {
    const el = document.getElementById(id);
    if(el) el.addEventListener(evt, fn);
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('is-active'));

    const targetPanel = document.querySelector(`.tab-panel[data-panel="${tabName}"]`);
    if(targetPanel) targetPanel.style.display = 'block';

    const targetBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    if(targetBtn) targetBtn.classList.add('is-active');

    const url = new URL(window.location);
    url.searchParams.set('t', tabName);
    window.history.replaceState({}, '', url);
}

// --- UPDATED LOADER LOGIC ---
function toggleLoader(show) {
    const loader = document.getElementById('directoryLoading');
    const section = document.getElementById('directorySection');
    
    if (show) {
        // Show loader
        loader.style.display = 'block';
        // Add 'loading' class to parent -> This triggers CSS to hide all .tab-panel
        section.classList.add('loading');
    } else {
        loader.style.display = 'none';
        section.classList.remove('loading');
    }
}

async function fetchDirectoryData() {
    toggleLoader(true); // Start Loading

    try {
        const res = await fetch('/api/directory/', {cache: "no-cache"});
        const data = await res.json();

        if(!data.success) {
            console.error(data.error);
            return;
        }

        directoryData = data;
        
        renderOfficials(data.officials);
        renderOffices(data.offices);
        renderHotlines(data.hotlines);

        populateSelect('pos-officials', data.filters.positions, 'All Positions');
        populateSelect('dist-officials', data.filters.districts, 'All Districts');

    } catch (err) {
        console.error("Fetch Error", err);
    } finally {
        // Stop Loading after a small delay to prevent flickering
        setTimeout(() => {
            toggleLoader(false);
        }, 300);
    }
}

function animateItems(containerId) {
    const container = document.getElementById(containerId);
    if(!container) return;
    const cards = container.querySelectorAll('.card');
    cards.forEach((card, idx) => {
        setTimeout(() => {
            card.classList.add('visible');
        }, 50 * idx);
    });
}

// --- Rendering Functions (Same as before) ---
function renderOfficials(list) {
    const grid = document.getElementById('grid-officials');
    const empty = document.getElementById('empty-officials');
    if(!grid) return;
    grid.innerHTML = '';

    if(!list || list.length === 0) {
        if(empty) empty.style.display = 'block';
        return;
    }
    if(empty) empty.style.display = 'none';

    list.forEach(o => {
        let imgHtml;
        const photoUrl = o.photo || "";
        if (photoUrl.trim() !== "") {
            const src = photoUrl.startsWith('http') ? photoUrl : STATIC_BASE_URL + photoUrl;
            imgHtml = `<img class="avatar avatar--img" src="${src}" alt="${escapeHtml(o.name)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`;
            imgHtml += `<div class="avatar" style="display:none">${escapeHtml(o.initials)}</div>`;
        } else {
            imgHtml = `<div class="avatar">${escapeHtml(o.initials)}</div>`;
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            ${imgHtml}
            <h3 class="card-title">${escapeHtml(o.name)}</h3>
            <div class="card-sub">${escapeHtml(o.position)}</div>
            ${o.district ? `<div style="margin:8px auto 0"><span class="badge badge--secondary">${escapeHtml(o.district)}</span></div>` : ''}
            
            <div class="meta">
                ${o.office ? `
                <div class="meta-row">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--muted)">
                        <path d="M480-480q33 0 56.5-23.5T560-560q0-33-23.5-56.5T480-640q-33 0-56.5 23.5T400-560q0 33 23.5 56.5T480-480Zm0 294q122-112 181-203.5T720-552q0-109-69.5-178.5T480-800q-101 0-170.5 69.5T240-552q0 71 59 162.5T480-186Zm0 106Q319-217 239.5-334.5T160-552q0-150 96.5-239T480-880q127 0 223.5 89T800-552q0 100-79.5 217.5T480-80Zm0-480Z" />
                    </svg>
                    <span>${escapeHtml(o.office)}</span>
                </div>` : ''}
                ${o.email ? `
                <div class="meta-row">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 -960 960 960" fill="var(--muted)">
                          <path d="M160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm320-280L160-640v400h640v-400L480-440Zm0-80 320-200H160l320 200ZM160-640v-80 480-400Z" />
                    </svg>
                    <span>${escapeHtml(o.email)}</span>
                </div>` : ''}
                ${o.phone ? `
                <div class="meta-row">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--muted)">
                        <path d="M798-120q-125 0-247-54.5T329-329Q229-429 174.5-551T120-798q0-18 12-30t30-12h162q14 0 25 9.5t13 22.5l26 140q2 16-1 27t-11 19l-97 98q20 37 47.5 71.5T387-386q31 31 65 57.5t72 48.5l94-94q9-9 23.5-13.5T670-390l138 28q14 4 23 14.5t9 23.5v162q0 18-12 30t-30 12Z" />
                    </svg>
                    <span>${escapeHtml(o.phone)}</span>
                </div>` : ''}
            </div>
        `;
        grid.appendChild(card);
    });
    animateItems('grid-officials');
}

function renderOffices(list) {
    const grid = document.getElementById('grid-offices');
    const empty = document.getElementById('empty-offices');
    if(!grid) return;
    grid.innerHTML = '';

    if(!list || list.length === 0) {
        if(empty) empty.style.display = 'block';
        return;
    }
    if(empty) empty.style.display = 'none';

    list.forEach(d => {
        let emailsHtml = (d.emails || []).map(e => `<div>${escapeHtml(e)}</div>`).join('');
        let phonesHtml = (d.phones || []).map(p => `<div>${escapeHtml(p)}</div>`).join('');

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 -960 960 960" style="flex:0 0 24px; color:var(--primary);">
                    <path fill="currentColor" d="M160-120q-33 0-56.5-23.5T80-200v-440q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v440q0 33-23.5 56.5T800-120H160Zm0-80h640v-440H160v440Zm240-520h160v-80H400v80ZM160-200v-440 440Z" />
                </svg>
                <h3 class="card-title" style="margin:0; text-align:start;">${escapeHtml(d.name)}</h3>
            </div>
            ${d.head ? `<div class="card-sub" style="text-align:start; margin-bottom:8px;">${escapeHtml(d.head)}</div>` : ''}

            <div class="meta">
                ${emailsHtml ? `
                <div class="meta-row">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 -960 960 960" fill="var(--muted)">
                        <path d="M160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm320-280L160-640v400h640v-400L480-440Zm0-80 320-200H160l320 200ZM160-640v-80 480-400Z" />
                    </svg>
                    <span class="break-all" style="display:flex; flex-direction:column; gap:2px;">${emailsHtml}</span>
                </div>` : ''}

                ${phonesHtml ? `
                <div class="meta-row">
                     <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 -960 960 960" fill="var(--muted)">
                        <path d="M798-120q-125 0-247-54.5T329-329Q229-429 174.5-551T120-798q0-18 12-30t30-12h162q14 0 25 9.5t13 22.5l26 140q2 16-1 27t-11 19l-97 98q20 37 47.5 71.5T387-386q31 31 65 57.5t72 48.5l94-94q9-9 23.5-13.5T670-390l138 28q14 4 23 14.5t9 23.5v162q0 18-12 30t-30 12Z" />
                    </svg>
                    <span style="display:flex; flex-direction:column; gap:2px;">${phonesHtml}</span>
                </div>` : ''}
            </div>
        `;
        grid.appendChild(card);
    });
    animateItems('grid-offices');
}

function renderHotlines(list) {
    const grid = document.getElementById('grid-hotlines');
    const empty = document.getElementById('empty-hotlines');
    if(!grid) return;
    grid.innerHTML = '';

    if(!list || list.length === 0) {
        if(empty) empty.style.display = 'block';
        return;
    }
    if(empty) empty.style.display = 'none';

    list.forEach(h => {
        let numbersHtml = (h.numbers || []).map(n => `<a class="hotline-link" href="tel:${escapeHtml(n)}">${escapeHtml(n)}</a>`).join('');

        const card = document.createElement('div');
        card.className = 'card hotline-card';
        card.innerHTML = `
            <div class="hotline-title">
                <svg class="i" style="height:24px; width:24px;color:red" viewBox="0 0 24 24">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.09 4.19 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.9.32 1.77.59 2.6a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.48-1.14a2 2 0 0 1 2.11-.45c.83.27 1.7.47 2.6.59A2 2 0 0 1 22 16.92Z" fill="none" stroke="red" stroke-width="2" />
                </svg>
                <span>${escapeHtml(h.service)}</span>
            </div>
            <div>${numbersHtml}</div>
        `;
        grid.appendChild(card);
    });
    animateItems('grid-hotlines');
}

function filterOfficials() {
    const q = (document.getElementById('q-officials').value || '').toLowerCase();
    const pos = document.getElementById('pos-officials').value;
    const dist = document.getElementById('dist-officials').value;

    const filtered = directoryData.officials.filter(o => {
        const matchesQ = (o.name + ' ' + o.position + ' ' + (o.office || '')).toLowerCase().includes(q);
        const matchesPos = pos === 'all' || o.position === pos;
        const matchesDist = dist === 'all' || (o.district === dist);
        return matchesQ && matchesPos && matchesDist;
    });
    renderOfficials(filtered);
}

function filterOffices() {
    const q = (document.getElementById('q-offices').value || '').toLowerCase();
    const filtered = directoryData.offices.filter(d => {
        return (d.name + ' ' + (d.head || '')).toLowerCase().includes(q);
    });
    renderOffices(filtered);
}

function filterHotlines() {
    const q = (document.getElementById('q-hotlines').value || '').toLowerCase();
    const filtered = directoryData.hotlines.filter(h => {
        const numStr = (h.numbers || []).join(' ');
        return (h.service + ' ' + numStr).toLowerCase().includes(q);
    });
    renderHotlines(filtered);
}

function populateSelect(id, items, defaultText) {
    const select = document.getElementById(id);
    if (!select || !items) return;
    select.innerHTML = `<option value="all">${defaultText}</option>`;
    items.forEach(item => {
        if(item) select.innerHTML += `<option value="${escapeHtml(item)}">${escapeHtml(item)}</option>`;
    });
}

function escapeHtml(text) {
    if (!text) return '';
    return String(text).replace(/[&<>"']/g, function(m) {
        return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m];
    });
}
</script>
{% endblock content %}