<section class="dash-panel" id="tab-complaints">

  <style>
    .complaint-card {
      width: 100%;
      text-align: left;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .complaint-card:hover {
      border-color: #d1d5db;
      background: #f9fafb;
    }

    .complaint-card.is-active {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .complaint-card-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .complaint-card-meta {
      font-size: 12px;
      color: #6b7280;
    }

    .badge-status {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      display: inline-block;
      margin-left: 6px;
      font-weight: 500;
    }

    .badge-status.Submitted {
      background: #fde68a;
      color: #92400e;
    }

    .badge-status.In.Progress {
      background: #bbf7d0;
      color: #166534;
    }

    .badge-status.Resolved {
      background: #bae6fd;
      color: #0c4a6e;
    }

    .skeleton {
      height: 70px;
      border-radius: 12px;
      background: linear-gradient(90deg, #f0f0f0 0%, #e5e5e5 50%, #f0f0f0 100%);
      background-size: 200%;
      animation: skeletonLoading 1.3s infinite;
      margin-bottom: 12px;
    }

    @keyframes skeletonLoading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .cmp-detail-meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .cmp-detail-meta-block p:first-child {
      margin-bottom: 4px;
    }

    .cmp-detail img {
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .cmp-detail img:hover {
      transform: scale(1.02);
    }
  </style>

  <div class="stat-grid mb-24">
    <a class="stat-card" href="#">
      <div class="stat-head">
        <span class="stat-title">Total Complaints</span>
        <svg class="i" viewBox="0 0 24 24">
          <path d="M3 4h18v16H3z" fill="none" stroke="currentColor" stroke-width="2" />
          <path d="M7 8h10M7 12h10M7 16h6" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-body">
        <div class="stat-num" data-cmp="total">0</div>
        <div class="stat-sub muted">Complaints you have submitted</div>
      </div>
    </a>
    <a class="stat-card" href="#">
      <div class="stat-head">
        <span class="stat-title">Pending Review</span>
        <svg class="i" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" />
          <path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-body">
        <div class="stat-num" data-cmp="pending">0</div>
        <div class="stat-sub muted">Submitted, waiting for action</div>
      </div>
    </a>
    <a class="stat-card" href="#">
      <div class="stat-head">
        <span class="stat-title">In Progress</span>
        <svg class="i" viewBox="0 0 24 24">
          <circle cx="12" cy="8" r="3" fill="none" stroke="currentColor" stroke-width="2" />
          <path d="M4 20c1.5-4 6.5-4 8-4s6.5 0 8 4" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-body">
        <div class="stat-num" data-cmp="inprogress">0</div>
        <div class="stat-sub muted">Currently being processed</div>
      </div>
    </a>
    <a class="stat-card" href="#">
      <div class="stat-head">
        <span class="stat-title">Recent Updates</span>
        <svg class="i" viewBox="0 0 24 24">
          <path d="M18 8a6 6 0 10-12 0v5L4 15v1h16v-1l-2-2V8z" fill="none" stroke="currentColor" stroke-width="2" />
          <path d="M10 19a2 2 0 004 0" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-body">
        <div class="stat-num" data-cmp="recent">0</div>
        <div class="stat-sub muted">New complaints in the last 7 days</div>
      </div>
    </a>
  </div>

  <nav class="dash-subtabs">
    <button class="dash-subtab is-active" data-subtab="submit">Submit Complaint</button>
    <button class="dash-subtab" data-subtab="track">Track Status</button>
  </nav>

  <!-- SUBMIT TAB -->
  <div class="dash-subpanel is-active" id="sub-submit">
    <div class="detail-card">
      <div class="card-head">
        <h3 class="card-title">Submit a Complaint</h3>
        <p class="muted">Report issues and provide feedback to help us serve you better</p>
      </div>
      <form id="form-complaint" class="grid">
        <!-- Your existing form fields here (unchanged) -->
        <!-- ... same as before ... -->
        <div class="grid" style="margin-bottom: 16px;">
          <label class="lbl">Category *</label>
          <div class="input-wrap">
            <div class="ui-select" data-name="cmp-category" aria-expanded="false">
              <select id="cmp-category" class="native-select"></select>
              <button type="button" class="ui-select__trigger select" data-trigger></button>
              <ul class="ui-select__menu" data-menu></ul>
            </div>
          </div>
        </div>

        <div class="grid" id="wrap-subcategory" style="display:none; margin-bottom: 16px;">
          <label class="lbl">Sub-Category *</label>
          <div class="input-wrap">
            <div class="ui-select" data-name="cmp-subcategory" aria-expanded="false">
              <select id="cmp-subcategory" class="native-select"></select>
              <button type="button" class="ui-select__trigger select" data-trigger></button>
              <ul class="ui-select__menu" data-menu></ul>
            </div>
          </div>
        </div>

        <div class="grid">
          <label class="lbl">Subject/Title *</label>
          <input id="cmp-subject" class="input" maxlength="100" placeholder="Brief description of the issue">
          <p class="muted tiny"><span id="cmp-subj-count">0</span>/100 characters</p>
        </div>

        <div class="grid">
          <label class="lbl">Location/Address *</label>
          <input id="cmp-location" class="input" placeholder="Please provide specific location details">
          <p class="muted tiny">Specific location details help us address your concern faster</p>
        </div>

        <div class="grid">
          <label class="lbl">Description *</label>
          <textarea id="cmp-description" class="input ta"
            placeholder="Provide detailed information about the issue"></textarea>
        </div>

        <div class="grid">
          <label class="lbl">Attachments (Optional)</label>
          <div class="dropzone" id="cmp-drop">
            <input id="cmp-files" type="file" multiple accept="image/*,.pdf" class="drop-input">
            <div class="drop-inner">
              <div class="drop-icon"><svg viewBox="0 0 24 24">
                  <path d="M6 17h11a3 3 0 0 0 .2-5.995A4.5 4.5 0 0 0 8.25 9.04 3.501 3.501 0 0 0 6 17z" fill="none"
                    stroke="currentColor" stroke-width="1.6" />
                  <path d="M12 7v8m0 0-3-3m3 3 3-3" fill="none" stroke="currentColor" stroke-width="1.6" />
                </svg></div>
              <p class="drop-title">Choose a file or drag & drop it here</p>
              <p class="drop-sub">JPEG, PNG, and PDF files, up to 10MB each</p>
              <label for="cmp-files" class="btn btn--outline drop-btn">Browse File</label>
            </div>
          </div>
          <div id="cmp-filelist" class="filelist"></div>
        </div>

        <div class="divider"></div>

        <label class="chk">
          <input type="checkbox" id="cmp-anon">
          <span>Submit Anonymously</span>
        </label>

        <div id="cmp-ident" class="grid grid-3">
          <div class="grid"><label class="lbl">Name</label><input id="cmp-name" class="input"
              placeholder="Your full name"></div>
          <div class="grid"><label class="lbl">Email</label><input id="cmp-email" class="input" type="email"></div>
          <div class="grid"><label class="lbl">Phone Number</label><input id="cmp-phone" class="input" type="tel"></div>
        </div>

        <button type="submit" class="btn btn--outline w-full" id="cmp-submit">Submit Complaint</button>
      </form>

      <div id="cmp-success" class="success-card" style="display:none">
        <div class="success-body">
          <svg class="i" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
            <path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" />
          </svg>
          <h2 class="h2">Complaint Submitted Successfully</h2>
          <p class="muted tiny">Thank you for helping us improve our services.</p>
          <button class="btn btn--outline" id="cmp-new">Submit Another Complaint</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRACK TAB -->
  <div class="dash-subpanel" id="sub-track">
    <div class="detail-card">
      <div class="card-head">
        <h3 class="card-title">Complaint History</h3>
        <p class="muted">View your submitted complaints and their current status</p>
      </div>
      <div class="grid grid-2 cmp-track-layout">
        <div>
          <p class="muted tiny">Submitted Complaints</p>
          <div id="cmp-list" class="list list--spaced"></div>
        </div>
        <div id="cmp-detail" class="cmp-detail">
          <p class="muted tiny cmp-detail-empty">Select a complaint from the list to view details.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (() => {
    const SUBMIT_URL = "/complaints/submit/";
    const LIST_URL = "/complaints/list/";
    const DETAIL_URL = "/complaints/";

    // YOUR CLOUDINARY SETTINGS (100% correct)
    const CLOUDINARY_CLOUD_NAME = "defkzzqcs";
    const CLOUDINARY_UPLOAD_PRESET = "complaints_unsigned";   // ← MUST match exactly what you created above

    const panel = document.getElementById("tab-complaints");
    if (!panel) return;

    const form = document.getElementById("form-complaint");
    const submitBtn = document.getElementById("cmp-submit");
    const successPanel = document.getElementById("cmp-success");
    const newBtn = document.getElementById("cmp-new");
    const fileInput = document.getElementById("cmp-files");
    const fileList = document.getElementById("cmp-filelist");

    let uploadedFiles = [];   // {name, url, size}

    const statTotal = panel.querySelector("[data-cmp='total']");
    const statPending = panel.querySelector("[data-cmp='pending']");
    const statProgress = panel.querySelector("[data-cmp='inprogress']");
    const statRecent = panel.querySelector("[data-cmp='recent']");

    function formatDate(s) {
      return new Date(s).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatBytes(b) {
      return b < 1024 * 1024 ? (b / 1024).toFixed(1) + ' KB' : (b / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function renderFileList() {
      fileList.innerHTML = "";
      uploadedFiles.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "file-pill";
        div.innerHTML = `
        <span>${f.name} <small class="muted">(${formatBytes(f.size)})</small></span>
        <button type="button" style="margin-left:8px;color:#ef4444;">Remove</button>
      `;
        div.querySelector("button").onclick = () => {
          uploadedFiles.splice(i, 1);
          renderFileList();
        };
        fileList.appendChild(div);
      });
    }

    // FILE UPLOAD TO CLOUDINARY (now with proper error handling)
    fileInput.addEventListener("change", async () => {
      const files = Array.from(fileInput.files);
      if (!files.length) return;

      submitBtn.disabled = true;
      submitBtn.textContent = "Uploading files…";

      for (const file of files) {
        if (file.size > 10 * 1024 * 1024) {
          alert(`"${file.name}" is bigger than 10 MB`);
          continue;
        }

        const fd = new FormData();
        fd.append("file", file);
        fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
        fd.append("folder", "complaints");

        try {
          const res = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`,
            { method: "POST", body: fd }
          );

          const json = await res.json();

          if (json.secure_url) {
            uploadedFiles.push({
              name: file.name,
              url: json.secure_url,
              size: file.size
            });
            renderFileList();
          } else {
            console.error("Cloudinary error:", json);
            alert(`Failed to upload "${file.name}"\nError: ${json.error?.message || "Unknown"}`);
          }
        } catch (err) {
          console.error(err);
          alert(`Upload failed for "${file.name}"`);
        }
      }

      fileInput.value = "";
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Complaint";
    });

    // SUBMIT COMPLAINT
    form.addEventListener("submit", async e => {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting…";

      const payload = {
        category: document.getElementById("cmp-category").value.trim(),
        subcategory: document.getElementById("cmp-subcategory")?.value.trim() || null,
        subject: document.getElementById("cmp-subject").value.trim(),
        location: document.getElementById("cmp-location").value.trim(),
        description: document.getElementById("cmp-description").value.trim(),
        is_anonymous: document.getElementById("cmp-anon").checked,
        attachments: uploadedFiles.map(f => ({ name: f.name, url: f.url, size: f.size }))
      };

      if (!payload.is_anonymous) {
        const name = document.getElementById("cmp-name").value.trim();
        const email = document.getElementById("cmp-email").value.trim();
        const phone = document.getElementById("cmp-phone").value.trim();
        if (name) payload.name = name;
        if (email) payload.email = email;
        if (phone) payload.phone = phone;
      }

      try {
        const res = await fetch(SUBMIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!data.success) throw new Error(data.error || "Server error");

        // SUCCESS
        form.reset();
        uploadedFiles = [];
        renderFileList();
        successPanel.style.display = "block";
        successPanel.scrollIntoView({ behavior: "smooth" });
        loadStats();
        if (document.querySelector('[data-subtab="track"]').classList.contains("is-active")) loadList();

      } catch (err) {
        alert("Submission failed: " + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Complaint";
      }
    });

    newBtn.onclick = () => {
      successPanel.style.display = "none";
      uploadedFiles = [];
      renderFileList();
    };

    // ————————————————————
    // LIST, DETAIL, STATS (unchanged – already perfect)
    // ————————————————————

    const listContainer = document.getElementById("cmp-list");
    const detailContainer = document.getElementById("cmp-detail");

    async function loadList() {
      detailContainer.innerHTML = '<p class="muted tiny cmp-detail-empty">Select a complaint from the list to view details.</p>';
      listContainer.innerHTML = '<div class="skeleton"></div>'.repeat(3);

      const res = await fetch(LIST_URL);
      const data = await res.json();
      if (!data.success || !data.items?.length) {
        listContainer.innerHTML = "<p class='muted tiny'>No complaints yet.</p>";
        return;
      }

      listContainer.innerHTML = "";
      data.items
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .forEach(item => {
          const btn = document.createElement("button");
          btn.className = "complaint-card";
          btn.dataset.id = item.id;
          btn.innerHTML = `
          <div class="complaint-card-title">${item.subject}</div>
          <div class="complaint-card-meta">
            ${item.category} • 
            <span class="badge-status ${item.status.replace(/ /g, ".")}">${item.status}</span> • 
            ${formatDate(item.created_at)}
          </div>`;
          btn.onclick = () => {
            document.querySelectorAll(".complaint-card").forEach(c => c.classList.remove("is-active"));
            btn.classList.add("is-active");
            loadDetail(item.id);
          };
          listContainer.appendChild(btn);
        });
      listContainer.firstElementChild?.click();
    }

    async function loadDetail(id) {
      detailContainer.innerHTML = "<p class='muted tiny'>Loading…</p>";

      try {
        const res = await fetch(DETAIL_URL + id + "/");
        const data = await res.json();
        if (!data.success || !data.complaint) throw new Error("Not found");

        const c = data.complaint;

        // Helper: Check if URL is image
        const isImage = (url) => /\.(jpe?g|png|gif|webp|bmp)$/i.test(url);

        // Render attachments with image preview
        const renderAttachments = () => {
          if (!c.attachments?.length) {
            return `<p class="muted tiny" style="margin:0;">No attachments.</p>`;
          }

          return `
        <div style="display: grid; gap: 12px; margin-top: 8px;">
          ${c.attachments.map(att => {
            const img = isImage(att.url);
            return `
              <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: #f9fafb;">
                ${img ? `
                  <a href="${att.url}" target="_blank" style="display:block;">
                    <img src="${att.url}" alt="${att.name}" loading="lazy"
                         style="width:100%; height:auto; max-height:300px; object-fit:cover; display:block;">
                  </a>
                ` : ''}
                <div style="padding:10px; display:flex; align-items:center; justify-content:space-between; background:white;">
                  <div style="flex:1; min-width:0;">
                    <p style="margin:0; font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                      ${att.name}
                    </p>
                    ${att.size ? `<p class="muted tiny" style="margin:4px 0 0;">${formatBytes(att.size)}</p>` : ''}
                  </div>
                  <a href="${att.url}" target="_blank" class="btn btn--outline btn--sm" style="margin-left:12px; white-space:nowrap;">
                    ${img ? 'View Full' : 'Download'}
                  </a>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;
        };

        detailContainer.innerHTML = `
      <div class="muted tiny">CMP-${String(c.id).toUpperCase().padStart(8, "0")}</div>
      <h3 style="margin:8px 0 16px; font-size:18px; font-weight:600;">${c.subject}</h3>

      <div class="cmp-detail-meta-grid">
        <div><p class="muted tiny">Status</p><span class="badge-status ${c.status.replace(/ /g, ".")}">${c.status}</span></div>
        <div><p class="muted tiny">Submitted</p>${formatDate(c.created_at)}</div>
        <div><p class="muted tiny">Category</p>${c.category}</div>
        <div><p class="muted tiny">Sub-Category</p>${c.subcategory || "—"}</div>
      </div>

      <div style="margin-top:20px;">
        <p class="muted tiny">Location</p>
        <p style="margin:4px 0 0; line-height:1.5;">${c.location || "—"}</p>
      </div>

      <div style="margin-top:20px;">
        <p class="muted tiny">Description</p>
        <p style="margin:4px 0 0; line-height:1.6; white-space:pre-wrap;">${c.description || "—"}</p>
      </div>

      ${!c.is_anonymous ? `
        <div style="margin-top:20px;">
          <p class="muted tiny">Submitted by</p>
          <p style="margin:4px 0 0; font-weight:500;">${c.name || "—"}</p>
          ${c.email || c.phone ? `<p class="muted tiny">${c.email || ""}${c.email && c.phone ? " • " : ""}${c.phone || ""}</p>` : ""}
        </div>
      ` : `
        <div style="margin-top:20px;">
          <p class="muted tiny">Submitted anonymously</p>
        </div>
      `}

      <div style="margin-top:24px;">
        <p class="muted tiny">Attachments</p>
        ${renderAttachments()}
      </div>
    `;

      } catch (err) {
        detailContainer.innerHTML = "<p class='muted tiny'>Failed to load details.</p>";
      }
    }

    async function loadStats() {
      const res = await fetch(LIST_URL);
      const data = await res.json();
      if (!data.success) return;
      const items = data.items || [];
      statTotal.textContent = items.length;
      statPending.textContent = items.filter(i => i.status === "Submitted").length;
      statProgress.textContent = items.filter(i => i.status === "In Progress").length;
      const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
      statRecent.textContent = items.filter(i => new Date(i.created_at) > weekAgo).length;
    }

    document.querySelector('[data-subtab="track"]').addEventListener("click", () => {
      loadList(); loadStats();
    });

    loadStats();
  })();
</script>