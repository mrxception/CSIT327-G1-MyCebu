<section class="dash-panel is-active" id="tab-services">
  <div class="detail-card" style="width:95%; margin:0 auto;"> <!-- widened -->
    <div class="card-head" style="margin-bottom:18px;">
      <h3 class="card-title">Services</h3>
      <p class="muted">Search and start an application</p>
    </div>

    <div id="servicesCardArea" style="display:flex; gap:12px; align-items:center; margin-bottom:18px; width:100%;"> <!-- full width -->
      <div style="flex:1; position:relative;">
        <input id="serviceSearch" type="search" placeholder="Search services (click to show all)" 
               style="width:100%; padding:12px 16px; border-radius:10px; border:1px solid #e6eef0; box-shadow:0 2px 6px rgba(2,6,23,0.04); font-size:1rem;">
      </div>
      <button id="clearSearch" type="button" style="background:#fff; border:1px solid #e6eef0; padding:10px 14px; border-radius:8px; cursor:pointer;">Clear</button>
    </div>

    <div id="servicesGrid" class="services-grid" style="width:100%; gap:12px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
      <!-- populated by JS -->
    </div>

    <p id="noResults" class="muted" style="display:none; margin-top:12px;">No services found.</p>
  </div>
</section>

<script>
(function () {
  const searchInput = document.getElementById('serviceSearch');
  const servicesGrid = document.getElementById('servicesGrid');
  const noResults = document.getElementById('noResults');
  const clearBtn = document.getElementById('clearSearch');
  const cardArea = document.getElementById('servicesCardArea');

  let services = [];
  let hideTimer = null;

  async function loadServices() {
    if (services.length) return services;
    try {
      const res = await fetch('/static/mycebu_app/data/services.json', {cache: "no-cache"});
      const data = await res.json();
      services = data.services || [];
    } catch (err) {
      console.error('Failed to load services.json', err);
      services = [];
    }
    return services;
  }

  function renderServices(list) {
    servicesGrid.innerHTML = '';

    if (!list || list.length === 0) {
      // no results — hide items and show message
      servicesGrid.classList.remove('visible');
      servicesGrid.style.display = 'none';
      noResults.style.display = 'block';
      return;
    }

    // have results — ensure message hidden and grid shown
    noResults.style.display = 'none';
    servicesGrid.style.display = 'grid';
    servicesGrid.classList.add('visible'); // ensure visible state for transition

    list.forEach((s, idx) => {
      const item = document.createElement('div');
      item.className = 'service-item';
      item.innerHTML = `
        <div>
          <h4 style="margin:0 0 6px 0; font-size:1.05rem; color:#0f172a;">${escapeHtml(s.title || s.id || '')}</h4>
          <p class="muted" style="margin:0; color:#6b7280; font-size:0.95rem;">${escapeHtml(s.subtitle || s.description || '')}</p>
        </div>
        <div style="margin-top:auto; display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn-apply" data-id="${escapeAttr(s.id || '')}">Apply</button>
          <a class="btn-learn" href="${escapeAttr(s.url || '#')}" target="_blank" rel="noopener noreferrer">Learn</a>
        </div>
      `;
      servicesGrid.appendChild(item);

      // stagger entrance
      setTimeout(() => item.classList.add('visible'), 30 * idx);
    });

    // attach handlers
    Array.from(servicesGrid.querySelectorAll('.btn-apply')).forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = btn.dataset.id;
        const applyUrl = `/apply/${encodeURIComponent(id)}/`;
        window.location.href = applyUrl;
      });
    });
  }

  function filterAndRender(q) {
    const term = (q || '').trim().toLowerCase();
    if (!term) {
      renderServices(services);
      return;
    }
    const filtered = services.filter(s => {
      const hay = ((s.title||'') + ' ' + (s.subtitle||'') + ' ' + (s.description||'') + ' ' + (s.id||'')).toLowerCase();
      return hay.indexOf(term) !== -1;
    });
    renderServices(filtered);
  }

  function showGrid() {
    if (!services.length) {
      loadServices().then(() => {
        renderServices(services);
        // delay adding visible for transition start
        requestAnimationFrame(() => servicesGrid.classList.add('visible'));
      });
    } else {
      renderServices(services);
      requestAnimationFrame(() => servicesGrid.classList.add('visible'));
    }
  }

  function hideGridImmediate() {
    servicesGrid.classList.remove('visible');
    // remove items after animation for cleanliness
    setTimeout(() => {
      servicesGrid.innerHTML = '';
      servicesGrid.style.display = 'none';
      noResults.style.display = 'none';
    }, 340);
  }

  function scheduleHide(delay = 300) {
    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
      // keep visible if input focused OR mouse is over the search area OR mouse is over the results grid
      const isInputFocused = (document.activeElement === searchInput);
      const isOverCardArea = cardArea.matches(':hover');
      const isOverGrid = servicesGrid && servicesGrid.matches(':hover');
      if (!isInputFocused && !isOverCardArea && !isOverGrid) {
        hideGridImmediate();
      }
    }, delay);
  }

  // escape helpers
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, function (m) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }
  function escapeAttr(s){ return escapeHtml(s); }

  // show list on focus/click
  searchInput.addEventListener('focus', async () => {
    showGrid();
  });
  searchInput.addEventListener('input', (e) => {
    filterAndRender(e.target.value);
  });

  // clear button
  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    filterAndRender('');
    searchInput.focus();
  });

  // keep visible while hovering either the control area or the results grid
  [cardArea, servicesGrid].forEach(el => {
    if (!el) return;
    el.addEventListener('mouseenter', () => {
      clearTimeout(hideTimer);
    });
    el.addEventListener('mouseleave', () => {
      scheduleHide(260);
    });
  });

  // hide when clicking outside anywhere
  document.addEventListener('click', (e) => {
    const within = e.target === searchInput || cardArea.contains(e.target) || (servicesGrid && servicesGrid.contains(e.target));
    if (!within) scheduleHide(0);
  });

  // also hide on input blur (with slight delay to allow click on results)
  searchInput.addEventListener('blur', () => {
    scheduleHide(260);
  });

})();
</script>
