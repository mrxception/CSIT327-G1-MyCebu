<style>
  /* Spinner Animation */
  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #e2e8f0;
    border-top-color: #0d9488;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
    vertical-align: middle;
    margin-right: 8px;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Common List Card Styles */
  .list-card {
    width: 100%;
    text-align: left;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: 0.15s ease;
  }

  .list-card:hover {
    border-color: #94a3b8;
    background: #f8fafc;
  }

  .list-card.is-active {
    border-color: #0d9488;
    background: #f0fdfa;
    box-shadow: 0 0 0 1px #0d9488;
  }

  .list-card-title {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 4px;
    color: #0f172a;
  }

  .list-card-meta {
    font-size: 12px;
    color: #64748b;
  }

  /* Service Grid Item */
  .service-item {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s ease;
    opacity: 0;
  }

  .service-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border-color: #cbd5e1;
  }

  .service-item.visible {
    opacity: 1;
  }

  /* Status Badges */
  .badge-status {
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 11px;
    display: inline-block;
    margin-left: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-status.submitted {
    background: #fef9c3;
    color: #854d0e;
    border: 1px solid #fde047;
  }

  .badge-status.pending {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
  }

  .badge-status.in.progress {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }

  .badge-status.resolved {
    background: #e0f2fe;
    color: #075985;
    border: 1px solid #bae6fd;
  }

  .badge-status.rejected {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  /* Layouts */
  .services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
    width: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .services-grid.visible {
    opacity: 1;
  }

  .split-view {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
    min-height: 500px;
    align-items: start;
  }

  @media (max-width: 768px) {
    .split-view {
      grid-template-columns: 1fr;
    }

    .split-view>div:first-child {
      border-right: none;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 20px;
      margin-bottom: 20px;
    }
  }
</style>

<section class="dash-panel is-active" id="tab-services">
  <nav class="dash-subtabs">
    <button class="dash-subtab is-active" data-svc-tab="browse">Browse Services</button>
    <button class="dash-subtab" data-svc-tab="track">My Applications</button>
  </nav>

  <div class="dash-subpanel is-active" id="svc-sub-browse">
    <div class="detail-card" style="width:95%; margin:0 auto;">
      <div class="card-head" style="margin-bottom:18px;">
        <h3 class="card-title">Services</h3>
        <p class="muted">Search and start an application</p>
      </div>

      <div id="serviceSearchContainer"
        style="display:flex; gap:12px; align-items:center; margin-bottom:18px; width:100%;">
        <div style="flex:1; position:relative;">
          <input id="serviceSearch" type="search" placeholder="Search services..."
            style="width:100%; padding:16px 18px; border-radius:10px; border:1px solid #e6eef0; box-shadow:0 2px 6px rgba(2,6,23,0.04); font-size:1.05rem; height:52px; outline:none; transition:border 0.2s;">
        </div>
        <button id="clearSearch" type="button"
          style="background:#fff; border:1px solid #e6eef0; padding:10px 14px; border-radius:8px; cursor:pointer;">Clear</button>
      </div>

      <div id="servicesLoading" style="display:none; text-align:center; padding:30px; color:#6b7280;">
        <div class="spinner"></div> Loading services...
      </div>

      <div id="servicesGrid" class="services-grid" style="display:none;"></div>
      <p id="noResults" class="muted" style="display:none; margin-top:12px;">No services found matching your search.</p>
    </div>
  </div>

  <div class="dash-subpanel" id="svc-sub-track">
    <div class="detail-card" style="width:95%; margin:0 auto;">
      <div class="card-head" style="margin-bottom:18px;">
        <h3 class="card-title">My Applications</h3>
        <p class="muted">Track the status of your permits</p>
      </div>

      <div class="split-view">
        <div style="border-right: 1px solid #f1f5f9; padding-right: 16px; height: 100%;">
          <p class="muted tiny" style="margin-bottom:12px; font-weight:600; text-transform:uppercase;">Recent
            Applications</p>
          <div id="permit-list-container" style="max-height: 600px; overflow-y: auto;"></div>
        </div>

        <div id="permit-detail-container" style="padding-left: 8px;">
          <div
            style="text-align:center; padding:60px 20px; color:#94a3b8; border: 2px dashed #e2e8f0; border-radius: 12px;">
            <svg style="width:48px; height:48px; margin:0 auto 12px; opacity:0.5;" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
              </path>
            </svg>
            <p class="muted">Select an application from the list to view its status.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="dash-panel" id="tab-complaints">
  <style>
    .complaint-card {
      width: 100%;
      text-align: left;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .complaint-card:hover {
      border-color: #d1d5db;
      background: #f9fafb;
    }

    .complaint-card.is-active {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .complaint-card-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .complaint-card-meta {
      font-size: 12px;
      color: #6b7280;
    }

    .skeleton {
      height: 70px;
      border-radius: 12px;
      background: linear-gradient(90deg, #f0f0f0 0%, #e5e5e5 50%, #f0f0f0 100%);
      background-size: 200%;
      animation: skeletonLoading 1.3s infinite;
      margin-bottom: 12px;
    }

    @keyframes skeletonLoading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .cmp-detail-meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .file-pill {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f1f5f9;
      font-size: 12px;
      margin-bottom: 6px;
    }
  </style>

  <div class="stat-grid mb-24">
    <a class="stat-card" href="#">
      <div class="stat-head">
        <span class="stat-title">Total Complaints</span>
        <svg class="i" viewBox="0 0 24 24">
          <path d="M3 4h18v16H3z" fill="none" stroke="currentColor" stroke-width="2" />
          <path d="M7 8h10M7 12h10M7 16h6" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-body">
        <div class="stat-num" data-cmp="total">0</div>
        <div class="stat-sub muted">Complaints you have submitted</div>
      </div>
    </a>
    <a class="stat-card" href="#">
      <div class="stat-head">
        <span class="stat-title">Pending Review</span>
        <svg class="i" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" />
          <path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-body">
        <div class="stat-num" data-cmp="pending">0</div>
        <div class="stat-sub muted">Submitted, waiting for action</div>
      </div>
    </a>
    <a class="stat-card" href="#">
      <div class="stat-head">
        <span class="stat-title">In Progress</span>
        <svg class="i" viewBox="0 0 24 24">
          <circle cx="12" cy="8" r="3" fill="none" stroke="currentColor" stroke-width="2" />
          <path d="M4 20c1.5-4 6.5-4 8-4s6.5 0 8 4" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-body">
        <div class="stat-num" data-cmp="inprogress">0</div>
        <div class="stat-sub muted">Currently being processed</div>
      </div>
    </a>
    <a class="stat-card" href="#">
      <div class="stat-head">
        <span class="stat-title">Recent Updates</span>
        <svg class="i" viewBox="0 0 24 24">
          <path d="M18 8a6 6 0 10-12 0v5L4 15v1h16v-1l-2-2V8z" fill="none" stroke="currentColor" stroke-width="2" />
          <path d="M10 19a2 2 0 004 0" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-body">
        <div class="stat-num" data-cmp="recent">0</div>
        <div class="stat-sub muted">New complaints in the last 7 days</div>
      </div>
    </a>
  </div>

  <nav class="dash-subtabs">
    <button class="dash-subtab is-active" data-subtab="submit">Submit Complaint</button>
    <button class="dash-subtab" data-subtab="track">Track Status</button>
  </nav>

  <div class="dash-subpanel is-active" id="sub-submit">
    <div class="detail-card">
      <div class="card-head">
        <h3 class="card-title">Submit a Complaint</h3>
        <p class="muted">Report issues and provide feedback to help us serve you better</p>
      </div>
      <form id="form-complaint" class="grid">
        <div class="grid" style="margin-bottom: 16px;">
          <label class="lbl">Category *</label>
          <div class="input-wrap">
            <div class="ui-select" data-name="cmp-category" aria-expanded="false">
              <select id="cmp-category" class="native-select"></select>
              <button type="button" class="ui-select__trigger select" data-trigger></button>
              <ul class="ui-select__menu" data-menu></ul>
            </div>
          </div>
        </div>

        <div class="grid" id="wrap-subcategory" style="display:none; margin-bottom: 16px;">
          <label class="lbl">Sub-Category *</label>
          <div class="input-wrap">
            <div class="ui-select" data-name="cmp-subcategory" aria-expanded="false">
              <select id="cmp-subcategory" class="native-select"></select>
              <button type="button" class="ui-select__trigger select" data-trigger></button>
              <ul class="ui-select__menu" data-menu></ul>
            </div>
          </div>
        </div>

        <div class="grid">
          <label class="lbl">Subject/Title *</label>
          <input id="cmp-subject" class="input" maxlength="100" placeholder="Brief description of the issue">
          <p class="muted tiny"><span id="cmp-subj-count">0</span>/100 characters</p>
        </div>

        <div class="grid">
          <label class="lbl">Location/Address *</label>
          <input id="cmp-location" class="input" placeholder="Please provide specific location details">
          <p class="muted tiny">Specific location details help us address your concern faster</p>
        </div>

        <div class="grid">
          <label class="lbl">Description *</label>
          <textarea id="cmp-description" class="input ta"
            placeholder="Provide detailed information about the issue"></textarea>
        </div>

        <div class="grid">
          <label class="lbl">Attachments (Optional)</label>
          <div class="dropzone" id="cmp-drop">
            <input id="cmp-files" type="file" multiple accept="image/*,.pdf" class="drop-input">
            <div class="drop-inner">
              <div class="drop-icon"><svg viewBox="0 0 24 24">
                  <path d="M6 17h11a3 3 0 0 0 .2-5.995A4.5 4.5 0 0 0 8.25 9.04 3.501 3.501 0 0 0 6 17z" fill="none"
                    stroke="currentColor" stroke-width="1.6" />
                  <path d="M12 7v8m0 0-3-3m3 3 3-3" fill="none" stroke="currentColor" stroke-width="1.6" />
                </svg></div>
              <p class="drop-title">Choose a file or drag & drop it here</p>
              <p class="drop-sub">JPEG, PNG, and PDF files, up to 10MB each</p>
              <label for="cmp-files" class="btn btn--outline drop-btn">Browse File</label>
            </div>
          </div>
          <div id="cmp-filelist" class="filelist"></div>
        </div>

        <div class="divider"></div>

        <label class="chk">
          <input type="checkbox" id="cmp-anon">
          <span>Submit Anonymously</span>
        </label>

        <div id="cmp-ident" class="grid grid-3">
          <div class="grid"><label class="lbl">Name</label><input id="cmp-name" class="input"
              placeholder="Your full name"></div>
          <div class="grid"><label class="lbl">Email</label><input id="cmp-email" placeholder="Your email" class="input"
              type="email"></div>
          <div class="grid"><label class="lbl">Phone Number</label><input id="cmp-phone" placeholder="Your phone number"
              class="input" type="tel"></div>
        </div>

        <button type="submit" class="btn btn--outline w-full" id="cmp-submit">Submit Complaint</button>
      </form>

      <div id="cmp-success" class="success-card" style="display:none">
        <div class="success-body">
          <svg class="i" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
            <path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" />
          </svg>
          <h2 class="h2">Complaint Submitted Successfully</h2>
          <p class="muted tiny">Thank you for helping us improve our services.</p>
          <button class="btn btn--outline" id="cmp-new">Submit Another Complaint</button>
        </div>
      </div>
    </div>
  </div>

  <div class="dash-subpanel" id="sub-track">
    <div class="detail-card">
      <div class="card-head">
        <h3 class="card-title">Complaint History</h3>
        <p class="muted">View your submitted complaints and their current status</p>
      </div>
      <div class="grid grid-2 cmp-track-layout">
        <div>
          <p class="muted tiny">Submitted Complaints</p>
          <div id="cmp-list" class="list list--spaced"></div>
        </div>
        <div id="cmp-detail" class="cmp-detail">
          <p class="muted tiny cmp-detail-empty">Select a complaint from the list to view details.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (function () {
    const API_SERVICES = '/api/services/';
    const API_MY_PERMITS = '/api/my-applications/';

    function setupTabs(tabId, prefix) {
      const buttons = document.querySelectorAll(`#${tabId} [data-${prefix}-tab]`);
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          buttons.forEach(b => b.classList.remove('is-active'));
          document.querySelectorAll(`#${tabId} .dash-subpanel`).forEach(p => p.classList.remove('is-active'));
          btn.classList.add('is-active');
          const target = btn.getAttribute(`data-${prefix}-tab`);
          document.getElementById(`${prefix}-sub-${target}`).classList.add('is-active');
          if (target === 'browse' && prefix === 'svc') showGrid();
          if (target === 'track' && prefix === 'svc') loadPermits();
        });
      });
    }

    setupTabs('tab-services', 'svc');

    let services = [];
    const searchInput = document.getElementById('serviceSearch');
    const servicesGrid = document.getElementById('servicesGrid');
    const noResults = document.getElementById('noResults');
    const loadingEl = document.getElementById('servicesLoading');
    const clearBtn = document.getElementById('clearSearch');
    let isFetching = false;

    function toggleLoader(show) {
      if (show) {
        loadingEl.style.display = 'block';
        servicesGrid.style.display = 'none';
        noResults.style.display = 'none';
      } else {
        loadingEl.style.display = 'none';
      }
    }

    async function fetchServices() {
      if (services.length > 0) return services;
      if (isFetching) return;
      try {
        isFetching = true;
        toggleLoader(true);
        const res = await fetch(API_SERVICES, { cache: "no-cache" });
        const data = await res.json();
        services = data.services || [];
      } catch (err) {
        console.error('Failed to load services', err);
        services = [];
      } finally {
        isFetching = false;
        toggleLoader(false);
      }
      return services;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]);
      });
    }
    function escapeAttr(s) { return escapeHtml(s); }

    function renderServices(list) {
      servicesGrid.innerHTML = '';
      if (!list || list.length === 0) {
        servicesGrid.classList.remove('visible');
        servicesGrid.style.display = 'none';
        if (!isFetching) noResults.style.display = 'block';
        return;
      }
      noResults.style.display = 'none';
      servicesGrid.style.display = 'grid';
      requestAnimationFrame(() => servicesGrid.classList.add('visible'));

      list.forEach((s, idx) => {
        const title = s.title || 'Untitled Service';
        const desc = s.description || '';
        const serviceId = s.id || '';
        const item = document.createElement('div');
        item.className = 'service-item';
        item.innerHTML = `
          <div>
            <h4 style="margin:0 0 6px 0; font-size:1.05rem; color:#0f172a;">${escapeHtml(title)}</h4>
            <p class="muted" style="margin:0; color:#6b7280; font-size:0.95rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(desc)}</p>
          </div>
          <div style="margin-top:auto; display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn-apply" data-id="${escapeAttr(serviceId)}">Apply</button>
          </div>
        `;
        servicesGrid.appendChild(item);
        setTimeout(() => item.classList.add('visible'), 30 * idx);
      });

      Array.from(servicesGrid.querySelectorAll('.btn-apply')).forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          if (id) window.location.href = `/apply/${encodeURIComponent(id)}/`;
        });
      });
    }

    function filterAndRender(q) {
      const term = (q || '').trim().toLowerCase();
      if (!term) { renderServices(services); return; }
      const filtered = services.filter(s => {
        const hay = ((s.title || '') + ' ' + (s.description || '') + ' ' + (s.id || '')).toLowerCase();
        return hay.indexOf(term) !== -1;
      });
      renderServices(filtered);
    }

    async function showGrid() {
      if (!services.length) {
        await fetchServices();
        renderServices(services);
      } else {
        renderServices(services);
      }
    }

    searchInput.addEventListener('input', (e) => filterAndRender(e.target.value));
    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      filterAndRender('');
      searchInput.focus();
    });

    const permitList = document.getElementById('permit-list-container');
    const permitDetail = document.getElementById('permit-detail-container');

    async function loadPermits() {
      permitList.innerHTML = '<div style="padding:40px; text-align:center;"><div class="spinner"></div></div>';
      try {
        const res = await fetch(API_MY_PERMITS, { cache: "no-cache" });
        const data = await res.json();
        if (!data.applications || data.applications.length === 0) {
          permitList.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8;"><p>No applications found.</p></div>';
          return;
        }
        permitList.innerHTML = '';
        data.applications.forEach(app => {
          const item = document.createElement('div');
          item.className = 'list-card';
          item.innerHTML = `
            <div class="list-card-title">${app.service_name}</div>
            <div class="list-card-meta">
               Ref: ${app.reference_number || 'N/A'} • <span style="text-transform:capitalize; color:#0d9488; font-weight:500;">${app.status}</span>
            </div>
          `;
          item.onclick = () => {
            document.querySelectorAll('#permit-list-container .list-card').forEach(c => c.classList.remove('is-active'));
            item.classList.add('is-active');
            renderPermitDetail(app);
          };
          permitList.appendChild(item);
        });
      } catch (e) {
        permitList.innerHTML = '<p class="muted tiny" style="text-align:center;">Error loading permits.</p>';
      }
    }

    function renderPermitDetail(app) {
      const progress = app.progress || 0;
      permitDetail.innerHTML = `
        <div style="border-bottom:1px solid #e2e8f0; padding-bottom:16px; margin-bottom:16px;">
          <span class="badge-status ${app.status.replace(/ /g, '.')}">${app.status}</span>
          <h3 style="margin:12px 0 4px; font-size:1.4rem;">${app.service_name}</h3>
          <p class="muted tiny">Ref: <span style="font-family:monospace; font-size:1.1em;">${app.reference_number}</span></p>
        </div>
        <div style="margin-bottom:24px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:12px; font-weight:600;">
             <span>Progress</span><span>${progress}%</span>
          </div>
          <div style="width:100%; background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden;">
             <div style="width:${progress}%; background:#0d9488; height:100%;"></div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
           <div>
              <p class="muted tiny">Applied Date</p>
              <p style="font-weight:600;">${new Date(app.created_at).toLocaleDateString()}</p>
           </div>
           <div>
              <p class="muted tiny">Current Step</p>
              <p style="font-weight:600;">Step ${app.step_index + 1}</p>
           </div>
        </div>
        ${app.admin_notes ? `
        <div style="background:#fff7ed; border:1px solid #ffedd5; padding:16px; border-radius:8px; margin-bottom:24px;">
           <p style="font-size:12px; font-weight:700; color:#c2410c; margin-bottom:4px; text-transform:uppercase;">Admin Note:</p>
           <p style="font-size:14px; color:#9a3412; line-height:1.5;">${app.admin_notes}</p>
        </div>` : ''}
        <div style="text-align:right;">
           <a href="/apply/${app.service_slug}/${app.id}/" class="btn btn--primary btn--sm">Continue / View Full</a>
        </div>
      `;
    }
    showGrid();
  })();
</script>

<script>
  (() => {
    // PREVENT DOUBLE INITIALIZATION
    const panel = document.getElementById("tab-complaints");
    if (!panel || panel.dataset.jsInitialized) return;
    panel.dataset.jsInitialized = "true";

    const SUBMIT_URL = "/complaints/submit/";
    const LIST_URL = "/complaints/list/";
    const DETAIL_URL = "/complaints/";
    const CLOUDINARY_CLOUD_NAME = "defkzzqcs";
    const CLOUDINARY_UPLOAD_PRESET = "complaints_unsigned";

    const form = document.getElementById("form-complaint");
    const submitBtn = document.getElementById("cmp-submit");
    const successPanel = document.getElementById("cmp-success");
    const newBtn = document.getElementById("cmp-new");
    const fileInput = document.getElementById("cmp-files");
    const fileList = document.getElementById("cmp-filelist");
    const listContainer = document.getElementById("cmp-list");
    const detailContainer = document.getElementById("cmp-detail");

    const statTotal = panel.querySelector("[data-cmp='total']");
    const statPending = panel.querySelector("[data-cmp='pending']");
    const statProgress = panel.querySelector("[data-cmp='inprogress']");
    const statRecent = panel.querySelector("[data-cmp='recent']");

    let uploadedFiles = [];
    let fetchController = null; // Used to abort previous requests

    function formatDate(s) {
      return new Date(s).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatBytes(b) {
      return b < 1024 * 1024 ? (b / 1024).toFixed(1) + ' KB' : (b / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // --- FILE HANDLING ---
    function renderFileList() {
      fileList.innerHTML = "";
      uploadedFiles.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "file-pill";
        div.innerHTML = `<span>${f.name} <small class="muted">(${formatBytes(f.size)})</small></span><button type="button" style="margin-left:8px;color:#ef4444;">Remove</button>`;
        div.querySelector("button").onclick = () => {
          uploadedFiles.splice(i, 1);
          renderFileList();
        };
        fileList.appendChild(div);
      });
    }

    fileInput.addEventListener("change", async () => {
      const files = Array.from(fileInput.files);
      if (!files.length) return;
      submitBtn.disabled = true;
      submitBtn.textContent = "Uploading files…";

      for (const file of files) {
        if (file.size > 10 * 1024 * 1024) { alert(`"${file.name}" is too big`); continue; }
        const fd = new FormData();
        fd.append("file", file);
        fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
        fd.append("folder", "complaints");
        try {
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, { method: "POST", body: fd });
          const json = await res.json();
          if (json.secure_url) {
            uploadedFiles.push({ name: file.name, url: json.secure_url, size: file.size });
            renderFileList();
          }
        } catch (err) { console.error(err); }
      }
      fileInput.value = "";
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Complaint";
    });

    // --- SUBMISSION ---
    form.addEventListener("submit", async e => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting…";
      const payload = {
        category: document.getElementById("cmp-category").value.trim(),
        subcategory: document.getElementById("cmp-subcategory")?.value.trim() || null,
        subject: document.getElementById("cmp-subject").value.trim(),
        location: document.getElementById("cmp-location").value.trim(),
        description: document.getElementById("cmp-description").value.trim(),
        is_anonymous: document.getElementById("cmp-anon").checked,
        attachments: uploadedFiles.map(f => ({ name: f.name, url: f.url, size: f.size }))
      };
      if (!payload.is_anonymous) {
        payload.name = document.getElementById("cmp-name").value.trim();
        payload.email = document.getElementById("cmp-email").value.trim();
        payload.phone = document.getElementById("cmp-phone").value.trim();
      }

      try {
        const res = await fetch(SUBMIT_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || "Server error");
        form.reset();
        uploadedFiles = [];
        renderFileList();
        successPanel.style.display = "block";
        successPanel.scrollIntoView({ behavior: "smooth" });
        loadStats();
        // If track tab is active, reload list
        if (panel.querySelector('[data-subtab="track"]').classList.contains("is-active")) loadList();
      } catch (err) {
        alert("Submission failed: " + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Complaint";
      }
    });

    newBtn.onclick = () => {
      successPanel.style.display = "none";
      uploadedFiles = [];
      renderFileList();
    };

    // --- LOADING LIST (FIXED) ---
    async function loadList() {
      // 1. Abort any previous pending fetch to prevent double-population
      if (fetchController) fetchController.abort();
      fetchController = new AbortController();

      // 2. Set skeleton UI
      detailContainer.innerHTML = '<p class="muted tiny cmp-detail-empty">Select a complaint from the list to view details.</p>';
      listContainer.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>';

      try {
        const res = await fetch(LIST_URL, {
          signal: fetchController.signal,
          cache: "no-store" // Prevent browser caching
        });
        const data = await res.json();

        // 3. STRICT CLEARING: Ensure container is empty before appending
        listContainer.innerHTML = "";

        if (!data.success || !data.items?.length) {
          listContainer.innerHTML = "<p class='muted tiny'>No complaints yet.</p>";
          return;
        }

        // 4. PREVENT DUPLICATES: Track IDs we have already rendered
        const seenIds = new Set();

        data.items
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .forEach(item => {
            if (seenIds.has(item.id)) return; // Skip duplicates
            seenIds.add(item.id);

            const btn = document.createElement("button");
            btn.className = "complaint-card";
            btn.dataset.id = item.id;
            const statusClass = item.status.toLowerCase().replace(/ /g, ".");

            btn.innerHTML = `
            <div class="complaint-card-title">${item.subject}</div>
            <div class="complaint-card-meta">
              ${item.category} • <span class="badge-status ${statusClass}">${item.status}</span> • ${formatDate(item.created_at)}
            </div>`;

            btn.onclick = () => {
              panel.querySelectorAll(".complaint-card").forEach(c => c.classList.remove("is-active"));
              btn.classList.add("is-active");
              loadDetail(item.id);
            };
            listContainer.appendChild(btn);
          });

        if (listContainer.firstElementChild) listContainer.firstElementChild.click();

      } catch (err) {
        if (err.name === 'AbortError') return; // Ignore aborted requests
        console.error(err);
        listContainer.innerHTML = "<p class='muted tiny'>Error loading list.</p>";
      }
    }

    async function loadDetail(id) {
      detailContainer.innerHTML = "<p class='muted tiny'>Loading details…</p>";
      try {
        const res = await fetch(DETAIL_URL + id + "/", { cache: "no-store" });
        const data = await res.json();
        if (!data.success || !data.complaint) throw new Error("Not found");
        const c = data.complaint;
        const statusClass = c.status.toLowerCase().replace(/ /g, ".");

        const renderAttachments = () => {
          if (!c.attachments?.length) return `<p class="muted tiny" style="margin:0;">No attachments.</p>`;
          return `<div style="display: grid; gap: 12px; margin-top: 8px;">
            ${c.attachments.map(att => `
              <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: #f9fafb;">
                <div style="padding:10px; display:flex; align-items:center; justify-content:space-between; background:white;">
                  <div style="flex:1; min-width:0;">
                    <a href="${att.url}" target="_blank" style="font-size:14px; font-weight:500; display:block; text-decoration:underline;">${att.name}</a>
                    ${att.size ? `<p class="muted tiny" style="margin:2px 0 0;">${formatBytes(att.size)}</p>` : ''}
                  </div>
                </div>
              </div>`).join("")}
          </div>`;
        };

        detailContainer.innerHTML = `
          <div class="muted tiny">CMP-${String(c.id).toUpperCase().padStart(8, "0")}</div>
          <h3 style="margin:8px 0 16px; font-size:18px; font-weight:600;">${c.subject}</h3>
          <div class="cmp-detail-meta-grid">
            <div><p class="muted tiny">Status</p><span class="badge-status ${statusClass}">${c.status}</span></div>
            <div><p class="muted tiny">Submitted</p>${formatDate(c.created_at)}</div>
            <div><p class="muted tiny">Category</p>${c.category}</div>
            <div><p class="muted tiny">Sub-Category</p>${c.subcategory || "—"}</div>
          </div>
          <div style="margin-top:20px;">
            <p class="muted tiny">Location</p>
            <p style="margin:4px 0 0;">${c.location || "—"}</p>
          </div>
          <div style="margin-top:20px;">
            <p class="muted tiny">Description</p>
            <p style="margin:4px 0 0; line-height:1.6; white-space:pre-wrap;">${c.description || "—"}</p>
          </div>
          ${!c.is_anonymous ? `
            <div style="margin-top:20px;">
              <p class="muted tiny">Submitted by</p>
              <p style="margin:4px 0 0; font-weight:500;">${c.name || "—"}</p>
              ${c.email || c.phone ? `<p class="muted tiny">${c.email || ""}${c.email && c.phone ? " • " : ""}${c.phone || ""}</p>` : ""}
            </div>` : `<div style="margin-top:20px;"><p class="muted tiny">Submitted anonymously</p></div>`}
          <div style="margin-top:24px;">
            <p class="muted tiny">Attachments</p>
            ${renderAttachments()}
          </div>
        `;
      } catch (err) {
        detailContainer.innerHTML = "<p class='muted tiny'>Failed to load details.</p>";
      }
    }

    async function loadStats() {
      try {
        const res = await fetch(LIST_URL, { cache: "no-store" });
        const data = await res.json();
        if (!data.success) return;
        const items = data.items || [];
        if (statTotal) statTotal.textContent = items.length;
        if (statPending) statPending.textContent = items.filter(i => i.status === "Pending").length;
        if (statProgress) statProgress.textContent = items.filter(i => i.status === "In Progress").length;
        const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
        if (statRecent) statRecent.textContent = items.filter(i => new Date(i.created_at) > weekAgo).length;
      } catch (e) { }
    }

    // --- TABS ---
    const subtabButtons = panel.querySelectorAll('[data-subtab]');
    const subpanels = panel.querySelectorAll('.dash-subpanel');

    subtabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        subtabButtons.forEach(b => b.classList.remove('is-active'));
        subpanels.forEach(p => p.classList.remove('is-active'));
        btn.classList.add('is-active');
        const target = btn.dataset.subtab;
        const panelEl = panel.querySelector('#sub-' + target);
        if (panelEl) panelEl.classList.add('is-active');
        if (target === 'track') {
          loadList();
          loadStats();
        }
      });
    });

    loadStats();
  })();
</script>