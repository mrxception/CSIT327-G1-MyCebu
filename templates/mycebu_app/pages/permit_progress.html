{% extends "mycebu_app/landing_base.html" %}
{% load static %}

{% block content %}
<section class="tab-content-section" data-loading="false">
  <header class="svc-hero" style="background:linear-gradient(135deg, #0d9488 0%, #059669 100%); color:white; padding:64px 24px; text-align:center;">
    <div class="container" style="max-width:1200px; margin:0 auto;">
      <div class="svc-hero__badge" style="display:inline-block; background:rgba(255,255,255,0.2); color:white; padding:8px 16px; border-radius:24px; font-size:0.875rem; font-weight:600; margin-bottom:16px;">
        Application Progress
      </div>
      <h1 class="svc-hero__title" style="font-size:2.5rem; font-weight:700; margin:0 0 12px 0;">{{ service.title }}</h1>
      <p class="svc-hero__desc" style="font-size:1.125rem; margin:0; opacity:0.95;">Track your permit application status</p>
      <p class="svc-hero__ref" style="margin-top:12px; font-size:0.875rem; opacity:0.9;">Reference: <strong>{{ app.reference_number }}</strong></p>
    </div>
  </header>

  <section class="detail-card" style="margin:48px auto; max-width:800px; padding:48px;">
    
    <!-- SUCCESS: Document Submitted or Verified -->
    {% if app.document_status == "pending" or app.document_status == "verified" %}
    <div class="svc-block" style="margin-bottom:24px; background:#d1fae5; padding:20px; border-radius:12px; border-left:5px solid #059669; text-align:center;">
      <svg style="width:32px; height:32px; color:#059669; margin-bottom:12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 style="margin:0 0 8px; font-size:1.3rem; color:#065f46;">
        {% if app.document_status == "verified" %}
          Document Verified - Approved!
        {% else %}
          Document Successfully Submitted!
        {% endif %}
      </h3>
      <p style="margin:0; color:#065f46;">
        {% if app.document_status == "verified" %}
          Your application has been approved. You will be notified soon.
        {% else %}
          Your document is under review. We'll notify you once verified.
        {% endif %}
      </p>
    </div>
    {% endif %}

    <!-- REJECTED -->
    {% if app.document_status == "rejected" %}
    %}
    <div class="svc-block" style="margin-bottom:24px; background:#fee2e2; padding:20px; border-radius:12px; border-left:5px solid #dc2626;">
      <svg style="width:32px; height:32px; color:#dc2626; margin-bottom:12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 style="margin:0 0 8px; color:#991b1b;">Document Rejected</h3>
      <p style="margin:0; color:#991b1b;">{{ app.admin_notes|default:"Please check requirements and resubmit." }}</p>
    </div>
    {% endif %}

    <!-- Progress Bar -->
    <div class="svc-block" style="margin-bottom:32px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        <span style="font-weight:600;">Progress</span>
        <span style="font-weight:700; color:#0d9488;">{{ app.progress }}%</span>
      </div>
      <div style="width:100%; height:12px; background:#e5e7eb; border-radius:6px; overflow:hidden;">
        <div style="height:100%; width:{{ app.progress }}%; background:#0d9488; transition:width 0.6s ease;"></div>
      </div>
    </div>

    <!-- UPLOAD BOX - Only show if NOT submitted or verified -->
    {% if app.document_status != "pending" and app.document_status != "verified" and app.step_index >= service.steps|length|add:"-1" %}
    <div class="svc-block" style="background:#f8fafc; padding:32px; border:2px dashed #94a3b8; border-radius:12px; text-align:center;">
      <h3 style="margin:0 0 16px; color:#1e293b;">Upload Final Document</h3>
      <p style="color:#64748b; margin-bottom:24px;">PDF, JPG, PNG, DOC/DOCX • Max 15MB</p>

      <div id="upload-area" style="border:2px solid #cbd5e1; border-radius:12px; padding:40px; background:white; cursor:pointer; transition:all 0.3s;">
        <div id="upload-placeholder">
          <svg style="width:56px; height:56px; color:#94a3b8; margin-bottom:16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5.5 5.5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <p style="margin:0; font-weight:600; color:#475569;">Click to upload or drag & drop</p>
        </div>
        <div id="upload-preview" style="display:none;">
          <p id="file-name" style="font-weight:600; margin:12px 0;"></p>
          <p id="file-size" style="color:#64748b; font-size:0.9rem;"></p>
          <button type="button" id="remove-file" style="margin-top:12px; color:#dc2626; background:none; border:none; cursor:pointer;">Remove file</button>
        </div>
      </div>

      <input type="file" id="document-file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display:none;">

      <div style="margin-top:24px;">
        <button id="submit-document" disabled style="background:#0d9488; color:white; padding:12px 32px; border:none; border-radius:8px; font-weight:600; cursor:not-allowed; opacity:0.6;">
          <span id="submit-text">Submit Document</span>
          <span id="submit-loader" style="display:none;">Loading...</span>
        </button>
        <p id="upload-error" style="color:#dc2626; margin-top:12px; display:none;"></p>
      </div>
    </div>
    {% endif %}

    <!-- Current Step -->
    <div class="svc-block" style="margin-top:32px;">
      <h3 style="margin-bottom:16px;">Current Step</h3>
      <div style="background:white; padding:20px; border-radius:10px; border:1px solid #e2e8f0;">
        <p style="margin:0 0 8px; font-weight:600; color:#0d9488;">
          Step {{ app.step_index|add:1 }} of {{ service.steps|length }}
        </p>
        {% with step_index=app.step_index %}
          <h4 style="margin:8px 0;">{{ service.steps|slice:"::"|slice:step_index|slice:":1"|join:"" }}</h4>
          {% if service.step_details and service.step_details|slice:step_index|slice:":1" %}
            <div style="margin-top:16px 0; padding:16px; background:#f0fdfa; border-radius:8px; border-left:4px solid #0d9488;">
              {{ service.step_details|slice:step_index|slice:":1"|join:""|safe }}
            </div>
          {% endif %}
        {% endwith %}
      </div>
    </div>

    <!-- Steps List -->
    <div class="svc-block" style="margin-top:32px;">
      <h3 style="margin-bottom:16px;">All Steps</h3>
      <ol style="margin:0; padding-left:24px; background:white; border-radius:10px; border:1px solid #e2e8f0;">
        {% for step in service.steps %}
          <li style="padding:12px 0; border-bottom:1px solid #f3f4f6; {% if forloop.counter0 == app.step_index %}font-weight:700; color:#0d9488;{% elif forloop.counter0 < app.step_index %}color:#6b7280;{% endif %}">
            {{ step }}
            {% if forloop.counter0 == app.step_index %}
              <span style="float:right; background:#d1fae5; color:#065f46; padding:4px 12px; border-radius:20px; font-size:0.8rem;">Current</span>
            {% elif forloop.counter0 < app.step_index %}
              <span style="float:right; background:#e5e7eb; color:#374151; padding:4px 12px; border-radius:20px; font-size:0.8rem;">Completed</span>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </div>

    <!-- Action Buttons -->
    <div style="margin-top:48px; display:flex; gap:16px; justify-content:center; flex-wrap:wrap;">
      {% if app.document_status != "pending" and app.document_status != "verified" %}
        {% if app.step_index < service.steps|length|add:"-1" %}
          <button id="nextStep" style="background:#0d9488; color:white; padding:12px 32px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
            Next Step →
          </button>
        {% else %}
          <button id="nextStep" style="background:#dc2626; color:white; padding:12px 32px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
            Complete Application
          </button>
        {% endif %}
      {% endif %}
      <a href="{% url 'landing_tab' tab='dashboard' %}" style="background:#f1f5f9; color:#0f172a; padding:12px 32px; border-radius:8px; text-decoration:none; font-weight:600;">
        Back to Dashboard
      </a>
    </div>

    <!-- Hidden Data for JS -->
    <div id="appData"
         data-step-index="{{ app.step_index }}"
         data-total-steps="{{ service.steps|length }}"
         data-app-id="{{ app.id }}"
         data-service-id="{{ service.service_id }}"
         data-update-url="{% url 'update_service_application' service=service.service_id app_id=app.id %}"
         data-upload-url="{% url 'upload_permit_document' service=service.service_id app_id=app.id %}"
         style="display:none;"></div>
  </section>
</section>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  #submit-loader::after {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #fff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
    margin-left: 8px;
  }
  #upload-area:hover { border-color: #0d9488; background: #f0fdfa; }
</style>

<script>
(() => {
  const dataEl = document.getElementById('appData');
  if (!dataEl) return;

  const currentIndex = parseInt(dataEl.dataset.stepIndex);
  const totalSteps = parseInt(dataEl.dataset.totalSteps);
  const updateUrl = dataEl.dataset.updateUrl;
  const uploadUrl = dataEl.dataset.uploadUrl;

  const nextBtn = document.getElementById('nextStep');
  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('document-file');
  const submitBtn = document.getElementById('submit-document');
  const submitText = document.getElementById('submit-text');
  const submitLoader = document.getElementById('submit-loader');
  const uploadError = document.getElementById('upload-error');
  const uploadPreview = document.getElementById('upload-preview');
  const fileNameEl = document.getElementById('file-name');
  const fileSizeEl = document.getElementById('file-size');

  let selectedFile = null;

  // === UPLOAD LOGIC ===
  if (uploadArea && fileInput && submitBtn) {
    uploadArea.onclick = () => fileInput.click();

    ['dragover', 'dragenter'].forEach(evt => {
      uploadArea.addEventListener(evt, e => {
        e.preventDefault();
        uploadArea.style.borderColor = '#0d9488';
        uploadArea.style.background = '#f0fdfa';
      });
    });

    ['dragleave', 'dragend', 'drop'].forEach(evt => {
      uploadArea.addEventListener(evt, e => {
        e.preventDefault();
        uploadArea.style.borderColor = '#cbd5e1';
        uploadArea.style.background = 'white';
      });
    });

    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    fileInput.onchange = e => {
      if (e.target.files.length) handleFile(e.target.files[0]);
    };

    document.getElementById('remove-file')?.addEventListener('click', () => {
      selectedFile = null;
      fileInput.value = '';
      document.getElementById('upload-placeholder').style.display = 'block';
      uploadPreview.style.display = 'none';
      submitBtn.disabled = true;
    });

    submitBtn.onclick = async () => {
      if (!selectedFile) return;

      const form = new FormData();
      form.append('document', selectedFile);

      submitBtn.disabled = true;
      submitText.textContent = '';
      submitLoader.style.display = 'inline-block';

      try {
        const res = await fetch(uploadUrl, {
          method: 'POST',
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          body: form
        });
        const json = await res.json();

        if (json.success) {
          alert('Document uploaded successfully!');
          location.reload();
        } else {
          uploadError.textContent = json.error || 'Upload failed';
          uploadError.style.display = 'block';
        }
      } catch (err) {
        uploadError.textContent = 'Network error';
        uploadError.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'Submit Document';
        submitLoader.style.display = 'none';
      }
    };
  }

  function handleFile(file) {
    if (file.size > 15*1024*1024) {
      uploadError.textContent = 'File too big (max 15MB)';
      uploadError.style.display = 'block';
      return;
    }
    const allowed = ['application/pdf','image/jpeg','image/jpg','image/png','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    if (!allowed.includes(file.type)) {
      uploadError.textContent = 'Invalid file type';
      uploadError.style.display = 'block';
      return;
    }

    selectedFile = file;
    document.getElementById('upload-placeholder').style.display = 'none';
    uploadPreview.style.display = 'block';
    fileNameEl.textContent = file.name;
    fileSizeEl.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    uploadError.style.display = 'none';
  }

  // === NEXT / COMPLETE BUTTON ===
  if (nextBtn) {
    nextBtn.onclick = async () => {
      const isLastStep = currentIndex >= totalSteps - 1;
      const payload = isLastStep ? { mark_completed: true } : { step_index: currentIndex + 1 };

      try {
        const res = await fetch(updateUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
          location.reload();
        } else {
          alert(data.error || 'Failed');
        }
      } catch (e) {
        alert('Network error');
      }
    };
  }
})();
</script>
{% endblock %}