{% extends "mycebu_app/landing_base.html" %}
{% load static %}

{% block content %}
<section class="tab-content-section" data-loading="false">
  <header class="svc-hero" style="background:linear-gradient(135deg, #0d9488 0%, #059669 100%); color:white; padding:64px 24px; text-align:center;">
    <div class="container" style="max-width:1200px; margin:0 auto;">
      <div class="svc-hero__badge" style="display:inline-block; background:rgba(255,255,255,0.2); color:white; padding:8px 16px; border-radius:24px; font-size:0.875rem; font-weight:600; margin-bottom:16px;">
        Application Progress
      </div>
      <h1 class="svc-hero__title" style="font-size:2.5rem; font-weight:700; margin:0 0 12px 0;">{{ service.title }}</h1>
      <p class="svc-hero__desc" style="font-size:1.125rem; margin:0; opacity:0.95;">Track your permit application status</p>
      <p class="svc-hero__ref" style="margin-top:12px; font-size:0.875rem; opacity:0.9;">Reference: <strong>{{ app.reference_number }}</strong></p>
    </div>
  </header>

  <section class="detail-card" style="margin:48px auto; max-width:800px; padding:48px;">
    
    <!-- SUCCESS: Document Submitted or Verified -->
    {% if app.document_status == "pending" or app.document_status == "verified" %}
    <div class="svc-block" style="margin-bottom:32px; background:#d1fae5; padding:32px; border-radius:16px; border-left:6px solid #059669; text-align:center;">
      <svg style="width:48px; height:48px; color:#059669; margin:0 auto 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 style="margin:0 0 16px; font-size:1.8rem; color:#065f46; font-weight:800;">
        {% if app.document_status == "verified" %}
          Document Verified - Approved!
        {% else %}
          Document Successfully Submitted!
        {% endif %}
      </h3>
      <p style="margin:0; color:#065f46; font-size:1.2rem; line-height:1.7;">
        {% if app.document_status == "verified" %}
          Your application has been approved! You will receive your permit soon.
        {% else %}
          Your document is under review. We will notify you once verified.
        {% endif %}
      </p>
    </div>
    {% endif %}

    <!-- REJECTED -->
    {% if app.document_status == "rejected" %}
    <div class="svc-block" style="margin-bottom:32px; background:#fee2e2; padding:32px; border-radius:16px; border-left:6px solid #dc2626; text-align:center;">
      <svg style="width:48px; height:48px; color:#dc2626; margin:0 auto 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 style="margin:0 0 16px; font-size:1.8rem; color:#991b1b; font-weight:800;">Document Rejected</h3>
      <p style="margin:0; color:#991b1b; font-size:1.2rem;">{{ app.admin_notes|default:"Please check requirements and resubmit." }}</p>
    </div>
    {% endif %}

    <!-- Progress Bar -->
    <div class="svc-block" style="margin-bottom:40px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
        <span style="font-weight:700; font-size:1.3rem;">Progress</span>
        <span style="font-weight:800; color:#0d9488; font-size:2rem;">{{ app.progress }}%</span>
      </div>
      <div style="width:100%; height:20px; background:#e5e7eb; border-radius:10px; overflow:hidden; box-shadow:inset 0 2px 6px rgba(0,0,0,0.1);">
        <div style="height:100%; width:{{ app.progress }}%; background:#0d9488; transition:width 1s ease;"></div>
      </div>
    </div>

    <!-- UPLOAD BOX — ONLY SHOW IF AT LAST STEP -->
    {% if app.step_index >= service.steps|length|add:"-1" %}
    <div class="svc-block" style="background:#f8fafc; padding:48px; border:4px dashed #94a3b8; border-radius:20px; text-align:center;">
      <h3 style="margin:0 0 24px; color:#1e293b; font-size:1.8rem; font-weight:800;">Upload Documents for Review</h3>
      <p style="color:#64748b; margin-bottom:40px; font-size:1.2rem;">Images or documents for admin review • PDF, JPG, PNG, DOC/DOCX • Max 15MB</p>

      <div id="upload-area" style="border:4px dashed #cbd5e1; border-radius:20px; padding:80px; background:white; cursor:pointer; transition:all 0.4s;">
        <div id="upload-placeholder">
          <svg style="width:80px; height:80px; color:#94a3b8; margin:0 auto 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          <p style="margin:0; color:#64748b; font-size:1.1rem;">Drag & drop or click to upload</p>
        </div>
        <div id="upload-preview" style="display:none;">
          <div style="margin-bottom:24px;"><span id="file-name" style="font-weight:600; color:#1e293b;"></span> • <span id="file-size" style="color:#64748b;"></span></div>
          <button id="remove-file" style="background:#f1f5f9; color:#0f172a; padding:8px 24px; border:none; border-radius:8px; cursor:pointer; font-weight:600;">Remove</button>
        </div>
      </div>

      <input type="file" id="document-file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display:none;">

      <div style="margin-top:40px;">
        <button id="submit-document" disabled style="background:#0d9488; color:white; padding:8px 16px; border:none; border-radius:8px; font-weight:600; cursor:not-allowed; opacity:0.7; min-width:140px; transition:all 0.3s;">
          <span id="submit-text">Submit Document</span>
          <span id="submit-loader" style="display:none;"></span>
        </button>
        <p id="upload-error" style="color:#dc2626; margin-top:20px; font-size:1rem; display:none;"></p>
      </div>
    </div>
    {% endif %}

    <!-- Current Step -->
    <div class="svc-block" style="margin-top:40px;">
      <h3 style="margin-bottom:20px; font-size:1.4rem;">Current Step</h3>
      <div style="background:white; padding:28px; border-radius:16px; border:2px solid #e2e8f0;">
        <p style="margin:0 0 12px; font-weight:700; color:#0d9488; font-size:1.2rem;">
          Step {{ app.step_index|add:1 }} of {{ service.steps|length }}
        </p>
        <h4 style="margin:12px 0; font-size:1.3rem; font-weight:600;">
          {{ service.steps|slice:app.step_index|slice:":1"|first }}
        </h4>
        {% if service.step_details %}
          {% with detail=service.step_details|slice:app.step_index|slice:":1"|first %}
            {% if detail %}
              <div style="margin-top:20px; padding:20px; background:#f0fdfa; border-radius:12px; border-left:5px solid #0d9488; font-size:1.05rem; line-height:1.7;">
                {{ detail|safe }}
              </div>
            {% endif %}
          {% endwith %}
        {% endif %}
      </div>
    </div>

    <!-- Steps List -->
    <div class="svc-block" style="margin-top:40px;">
      <h3 style="margin-bottom:20px; font-size:1.4rem;">All Steps</h3>
      <ol style="margin:0; padding-left:32px; background:white; border-radius:16px; border:2px solid #e2e8f0; list-style-position:inside;">
        {% for step in service.steps %}
          <li style="display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:2px solid #f3f4f6; font-size:1.1rem; {% if forloop.counter0 == app.step_index %}font-weight:700; color:#0d9488;{% elif forloop.counter0 < app.step_index %}color:#6b7280;{% endif %}">
            <span>{{ step }}</span>
            {% if forloop.counter0 == app.step_index %}
              <span style="background:#d1fae5; color:#065f46; padding:8px 16px; border-radius:999px; font-size:0.9rem; font-weight:700; white-space:nowrap; margin-left:12px;">Current</span>
            {% elif forloop.counter0 < app.step_index %}
              <span style="background:#e5e7eb; color:#374151; padding:8px 16px; border-radius:999px; font-size:0.9rem; font-weight:700; white-space:nowrap; margin-left:12px;">Completed</span>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </div>

    <!-- Action Buttons -->
    <div style="margin-top:60px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
      {% if app.progress < 100 %}
        {% if app.step_index < service.steps|length|add:"-1" %}
          <button id="nextStep" style="min-width:160px; background:#0d9488; color:white; padding:10px 18px; border:none; border-radius:8px; font-weight:600; box-shadow:0 2px 8px rgba(13,148,136,0.12); cursor:pointer; transition:all 0.3s;" onmouseover="this.style.background='#0c7f78'; this.style.boxShadow='0 4px 12px rgba(13,148,136,0.2)';" onmouseout="this.style.background='#0d9488'; this.style.boxShadow='0 2px 8px rgba(13,148,136,0.12)';">
            Next Step
          </button>
        {% else %}
          <button id="completeStep" style="min-width:160px; background:#059669; color:white; padding:10px 18px; border:none; border-radius:8px; font-weight:600; box-shadow:0 2px 8px rgba(5,150,105,0.12); cursor:pointer; transition:all 0.3s;" onmouseover="this.style.background='#047857'; this.style.boxShadow='0 4px 12px rgba(5,150,105,0.2)';" onmouseout="this.style.background='#059669'; this.style.boxShadow='0 2px 8px rgba(5,150,105,0.12)';">
            <span id="complete-text">Complete Step</span>
            <span id="complete-loader" style="display:none;"></span>
          </button>
        {% endif %}
      {% endif %}
      <a href="{% url 'landing_tab' tab='dashboard' %}" style="min-width:160px; background:#ffffff; color:#0f172a; border:1px solid #e6eef0; padding:10px 18px; border-radius:8px; font-weight:600; text-decoration:none; text-align:center; transition:all 0.3s;" onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#cbd5e1';" onmouseout="this.style.background='#ffffff'; this.style.borderColor='#e6eef0';">
        Back to Dashboard
      </a>
    </div>

    <div id="appData"
         data-step-index="{{ app.step_index }}"
         data-total-steps="{{ service.steps|length }}"
         data-app-id="{{ app.id }}"
         data-service-id="{{ service.service_id }}"
         data-update-url="{% url 'update_service_application' service=service.service_id app_id=app.id %}"
         data-upload-url="{% url 'upload_permit_document' service=service.service_id app_id=app.id %}"
         style="display:none;"></div>
  </section>
</section>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  #submit-loader::after { content: ''; display: inline-block; width: 18px; height: 18px; border: 3px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-left: 12px; }
  #complete-loader::after { content: ''; display: inline-block; width: 18px; height: 18px; border: 3px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-left: 12px; }
  #upload-area:hover { border-color: #0d9488; background: #f0fdfa; }
</style>

<script>
(() => {
  const dataEl = document.getElementById('appData');
  if (!dataEl) return;

  const currentIndex = parseInt(dataEl.dataset.stepIndex);
  const totalSteps = parseInt(dataEl.dataset.totalSteps);
  const updateUrl = dataEl.dataset.updateUrl;
  const uploadUrl = dataEl.dataset.uploadUrl;

  const nextBtn = document.getElementById('nextStep');
  const completeBtn = document.getElementById('completeStep');
  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('document-file');
  const submitBtn = document.getElementById('submit-document');
  const submitText = document.getElementById('submit-text');
  const submitLoader = document.getElementById('submit-loader');
  const completeText = document.getElementById('complete-text');
  const completeLoader = document.getElementById('complete-loader');
  const uploadError = document.getElementById('upload-error');
  const uploadPreview = document.getElementById('upload-preview');
  const fileNameEl = document.getElementById('file-name');
  const fileSizeEl = document.getElementById('file-size');

  let selectedFile = null;

  if (uploadArea && fileInput && submitBtn) {
    uploadArea.onclick = () => fileInput.click();
    ['dragover', 'dragenter'].forEach(e => uploadArea.addEventListener(e, ev => { ev.preventDefault(); uploadArea.style.borderColor = '#0d9488'; uploadArea.style.background = '#f0fdfa'; }));
    ['dragleave', 'drop'].forEach(e => uploadArea.addEventListener(e, ev => { ev.preventDefault(); uploadArea.style.borderColor = '#cbd5e1'; uploadArea.style.background = 'white'; }));
    uploadArea.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
    fileInput.onchange = e => { if (e.target.files.length) handleFile(e.target.files[0]); };
    document.getElementById('remove-file')?.addEventListener('click', () => { selectedFile = null; fileInput.value = ''; document.getElementById('upload-placeholder').style.display = 'block'; uploadPreview.style.display = 'none'; submitBtn.disabled = true; });

    submitBtn.onclick = async () => {
      if (!selectedFile) return;
      const form = new FormData(); form.append('document', selectedFile);
      submitBtn.disabled = true; submitBtn.style.opacity = '0.7'; submitBtn.style.cursor = 'not-allowed'; submitText.textContent = ''; submitLoader.style.display = 'inline-block';
      try {
        const res = await fetch(uploadUrl, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: form });
        const json = await res.json();
        if (json.success) { alert('Document uploaded successfully!'); location.reload(); }
        else { uploadError.textContent = json.error || 'Upload failed'; uploadError.style.display = 'block'; }
      } catch { uploadError.textContent = 'Network error'; uploadError.style.display = 'block'; }
      finally { submitBtn.disabled = false; submitBtn.style.opacity = '1'; submitBtn.style.cursor = 'pointer'; submitText.textContent = 'Submit Document'; submitLoader.style.display = 'none'; }
    };
  }

  function handleFile(file) {
    if (file.size > 15*1024*1024) return void (uploadError.textContent = 'File too big (max 15MB)', uploadError.style.display = 'block');
    const allowed = ['application/pdf','image/jpeg','image/jpg','image/png','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    if (!allowed.includes(file.type)) return void (uploadError.textContent = 'Invalid file type', uploadError.style.display = 'block');
    selectedFile = file;
    document.getElementById('upload-placeholder').style.display = 'none';
    uploadPreview.style.display = 'block';
    fileNameEl.textContent = file.name;
    fileSizeEl.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    uploadError.style.display = 'none';
  }

  if (nextBtn) {
    nextBtn.onclick = async () => {
      const payload = { step_index: currentIndex + 1 };
      try {
        const res = await fetch(updateUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data.success) location.reload();
        else alert(data.error || 'Failed');
      } catch { alert('Network error'); }
    };
  }

  if (completeBtn) {
    completeBtn.onclick = async () => {
      if (!selectedFile) {
        alert('Please upload a document before completing this step.');
        return;
      }
      completeBtn.disabled = true;
      completeText.textContent = '';
      completeLoader.style.display = 'inline-block';
      
      try {
        const form = new FormData();
        form.append('document', selectedFile);
        const res = await fetch(uploadUrl, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: form });
        const json = await res.json();
        if (json.success) {
          const completeRes = await fetch(updateUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }, body: JSON.stringify({ mark_completed: true }) });
          const completeData = await completeRes.json();
          if (completeData.success) {
            alert('Step completed successfully!');
            location.reload();
          } else {
            alert(completeData.error || 'Failed to complete step');
          }
        } else {
          alert(json.error || 'Document upload failed');
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      } finally {
        completeBtn.disabled = false;
        completeText.textContent = 'Complete Step';
        completeLoader.style.display = 'none';
      }
    };
  }
})();
</script>
{% endblock %}