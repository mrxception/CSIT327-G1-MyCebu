{# templates/mycebu_app/pages/ordinances.html #}
{% extends 'mycebu_app/landing_base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

<section class="tab-content-section" data-loading="false" data-skel="ordinances">
    <header class="svc-hero">
    <div class="container">
      <div class="svc-hero__badge">
        <svg class="i i--badge" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="none" stroke="currentColor"
            stroke-width="2" />
          <path d="M14 2v6h6" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
        Government Services Portal
      </div>
      <h1 class="svc-hero__title">Cebu City Ordinances</h1>
      <p class="svc-hero__desc">Access the official database of city laws, executive orders, and resolutions directly from the City Council.</p>
    </div>
  </header>

    <div class="container">
        <div class="ord-controls">
            <form action="{% url 'landing_tab' 'ordinances' %}" method="GET">
                
                <div class="ord-search-wrap">
                    <span class="material-symbols-rounded ord-search-icon">search</span>
                    <input type="text" name="q" placeholder="Search by name, position, or office" value="{{ request.GET.q }}">
                </div>

                <select name="author" class="ord-select" onchange="this.form.submit()">
                    <option value="">All Positions</option>
                    {% for auth in authors_list %}
                    <option value="{{ auth }}" {% if request.GET.author == auth %}selected{% endif %}>{{ auth }}</option>
                    {% endfor %}
                </select>

                <select name="category" class="ord-select" onchange="this.form.submit()">
                    <option value="">All Districts</option>
                    {% for cat in categories_list %}
                    <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <div class="services-container" style="padding-top: 20px;">
            {% if ordinances_data %}
                {# Regroup data by Category #}
                {% regroup ordinances_data by category as category_list %}

                {% for category in category_list %}
                    <div class="category-group">
                        <h2 class="category-header">
                            <span class="material-symbols-rounded" style="color: #2563eb;">folder_open</span>
                            {{ category.grouper|default:"General" }}
                        </h2>
                        
                        <div class="ord-grid">
                            {% for ord in category.list %}
                            <article class="ord-card">
                                <div class="tag-badge">
                                    <span class="material-symbols-rounded" style="font-size:14px;">label</span>
                                    {{ ord.category }}
                                </div>

                                <h3 class="ord-title">{{ ord.name_or_ordinance }}</h3>

                                <div class="ord-meta">
                                    <div class="ord-meta-row">
                                        <span class="material-symbols-rounded icon-sm">person</span>
                                        <span>{{ ord.author|default:"Unknown Author" }}</span>
                                    </div>
                                    <div class="ord-meta-row">
                                        <span class="material-symbols-rounded icon-sm">tag</span>
                                        <span>No. {{ ord.ordinance_number }}</span>
                                    </div>
                                    <div class="ord-meta-row">
                                        <span class="material-symbols-rounded icon-sm">calendar_month</span>
                                        <span>{{ ord.date_of_enactment|default:"Date Pending" }}</span>
                                    </div>
                                </div>

                                <button type="button" class="btn-preview" 
                                        onclick="openPdfPreview('{{ ord.pdf_file_path }}', '{{ ord.name_or_ordinance|escapejs }}')">
                                    <span class="material-symbols-rounded">visibility</span>
                                    Preview File
                                </button>
                            </article>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-msg" style="display:block; text-align:center; padding: 60px;">
                    <span class="material-symbols-rounded" style="font-size: 48px; color: #d1d5db;">search_off</span>
                    <h3 class="h3" style="margin-top:10px;">No Ordinances Found</h3>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<div id="pdfModal" class="pdf-modal-overlay">
    <div class="pdf-modal-content">
        <div class="pdf-header">
            <div class="pdf-title-text" id="pdfModalTitle">Document Preview</div>
            <div class="pdf-actions">
                <button class="btn-pdf-action" onclick="printPdf()" title="Print">
                    <span class="material-symbols-rounded">print</span>
                </button>
                <a id="downloadLink" class="btn-pdf-action" download title="Download">
                    <span class="material-symbols-rounded">download</span>
                </a>
                <button class="btn-close-modal" onclick="closePdfPreview()">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
        </div>
        <div class="pdf-body">
            <iframe id="pdfViewerFrame" class="pdf-frame" src="" allow="fullscreen"></iframe>
        </div>
    </div>
</div>

{% endblock content %}